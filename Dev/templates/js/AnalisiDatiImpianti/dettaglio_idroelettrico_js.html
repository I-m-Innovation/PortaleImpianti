<script>
		$(document).ready(function(){
				console.log('Document ready - inizializzazione grafici');
				
				/* ID CHARTS */
				var Chart1 = echarts.init(document.getElementById('chart-year'));
				var Chart2 = echarts.init(document.getElementById('chart-3D'));
				console.log('Grafici inizializzati:', Chart1, Chart2);
                
				window.addEventListener('resize', function() {Chart1.resize();});
				window.addEventListener('resize', function() {Chart2.resize();});
				
				/* URL DATI */
				var endpoint = '{% url 'api-analisi-impianto' nickname %}';
				console.log('Endpoint API:', endpoint);
				
				/* VARIABILI */
				var potenza = [];
				var portata = [];
				var pressione = [];
				var timestamps = [];
				var rendimento = [];
				let today_max = 0;
				let month_max = 0;
				let year_max = 0;
				
				const warmpalette = [
						'rgb(255,227,161)', 'rgb(232,183,20)',
						'rgb(180,152,133)','rgb(116,87,69)',
						'rgb(220,156,191)','rgb(160,27,104)',
						'rgb(255,194,190)','rgb(209,65,36)',
				];
				const coolpalette = [
						'rgb(173,220,145)', 'rgb(31,160,64)',
						'rgb(137,182,181)','rgb(0,114,206)',
						'rgb(37,118,117)','rgb(157,174,204)',
						'rgb(126,183,232)','rgb(37,75,135)',
				];
				const colors = [warmpalette[7],coolpalette[3],warmpalette[2],coolpalette[3],coolpalette[2]]
				console.log('Palette colori configurate');
				
				/* CHIAMATA AJAX PER I DATI */
				console.log('Inizio chiamata AJAX per i dati');
				$.get(endpoint).done(function (Chart_data) {
						console.log('Dati ricevuti dall\'API:', Chart_data);
						
						/* AGGIORNAMENTO VARIABILI */
						timestamps = Chart_data.time;
						potenza = Chart_data.pot;
						portata = Chart_data.port;
						pressione = Chart_data.pres;
						rendimento = Chart_data.eta;
						today_max = Chart_data.today_max;
						month_max = Chart_data.month_max;
						year_max = Chart_data.year_max;
						/* GESTIONE GAP TEMPORALI > 15 MINUTI: preparo serie [tempo, valore] con null per spezzare la linea */
						const parseDateFromIT = (s) => {
								if (!s) return null;
								const parts = s.split(' ');
								if (parts.length < 2) return null;
								const [dd, mm, yyyy] = parts[0].split('/');
								const hhmm = parts[1];
								return new Date(`${yyyy}-${mm}-${dd}T${hhmm}:00`);
						};
						const toNumOrNull = v => {
							if (v === '' || v === null || v === undefined || isNaN(v)) {
								return null;
							}
							const num = Number(v);
							return isNaN(num) ? null : num;
						};
						const dates = timestamps.map(parseDateFromIT);
						const GAP_MS = 15 * 60 * 1000; // 15 minuti

						let dataPotenza = [];
						let dataPortata = [];
						let dataPressione = [];
						let dataRendimento = [];

						for (let i = 0; i < dates.length; i++) {
								const d = dates[i];
								dataPotenza.push([d, toNumOrNull(potenza[i])]);
								dataPortata.push([d, toNumOrNull(portata[i])]);
								dataPressione.push([d, toNumOrNull(pressione[i])]);
								dataRendimento.push([d, toNumOrNull(rendimento[i])]);

								if (i < dates.length - 1 && dates[i] && dates[i+1]) {
										const delta = dates[i+1] - dates[i];
										if (delta > GAP_MS) {
												const mid = new Date(dates[i].getTime() + Math.floor(delta / 2));
												dataPotenza.push([mid, null]);
												dataPortata.push([mid, null]);
												dataPressione.push([mid, null]);
												dataRendimento.push([mid, null]);
										}
								}
						}
						
						console.log('Variabili aggiornate:');
						console.log('- Timestamps length:', timestamps.length);
						console.log('- Potenza length:', potenza.length);
						console.log('- Portata length:', portata.length);
						console.log('- Pressione length:', pressione.length);
						console.log('- Rendimento length:', rendimento.length);
						console.log('- Today max:', today_max);
						console.log('- Month max:', month_max);
						console.log('- Year max:', year_max);
						
						// Filtra le coordinate 3D per rimuovere punti con valori null/NaN
						let coords = [];
						for (let i = 0; i < portata.length; i++) {
							const port = portata[i];
							const pres = pressione[i];
							const rend = rendimento[i];
							
							// Solo aggiungi il punto se tutti i valori sono validi
							if (port !== null && pres !== null && rend !== null && 
								!isNaN(port) && !isNaN(pres) && !isNaN(rend)) {
								coords.push([port, pres, rend]);
							}
						}
						console.log('Coordinate 3D generate:', coords.length, 'punti (filtrate da', portata.length, 'totali)');
                            
						/* AGGIORNAMTO MASSIMI GIORNO, MESE, ANNO */
						// Funzione per gestire valori null/NaN nei massimi
						const safeToLocale = (value, decimals) => {
							if (value === null || value === undefined || isNaN(value)) {
								return 'N/A';
							}
							return toLocale(value, decimals);
						};
						
						document.getElementById("today_max").innerHTML = safeToLocale(today_max,2) + ' kW';
						document.getElementById("month_max").innerHTML = safeToLocale(month_max,2) + ' kW';
						document.getElementById("year_max").innerHTML = safeToLocale(year_max,2) + ' kW';
						console.log('Elementi DOM aggiornati con i massimi');
						
						/* GRAFICO DATI ANNO */
						console.log('Configurazione grafico principale...');
						Chart1.setOption({
								title: false, 
								color: colors, 
								tooltip: {trigger: 'axis'}, 
								legend: {},
								toolbox: {right: 10, top: 0,
										feature: {
												dataZoom: {xAxisIndex: 'none', },
												dataView: {show: true, readOnly: false }, 
												restore: {show: true}, 
												saveAsImage: {show: true}
										}
								},
                dataZoom: [
	                  {bottom:'1%',show: true, realtime: true, start: 90, end: 100, xAxisIndex: [0,1],height: 60,throttle: 0},
	                  {type: 'inside',show: true, realtime: true, start: 90, end: 100,xAxisIndex: [0,1],height: 60,throttle: 0}
                ],
								/* DUE GRAFICI COLLEGATI SOPRA: POTENZA E PORTATA, SOTTO: RENDIMENTO, PORTATA E PRESSIONE*/
							  grid: [{top: '5%', height: '42%',right: '10%' }, {top: '47%', height: '42%',right: '10%'}],
						/* TIMESTAMPS */
						xAxis: [
								{gridIndex: 0, type: 'time', splitLine:{ show: true }, axisLine: {show: true}, axisTick: {show: false}, axisLabel: {show:false}},
								{gridIndex: 1, type: 'time', splitLine:{ show: true }, axisLine: {show: true}, axisTick: {show: true}},
						],
								/* FORMAT ASSE Y */
                yAxis: [
                    {
                        gridIndex: 0, type: 'value', name: 'Potenza (kW)', nameLocation: 'middle', nameGap: 32,
                        axisLine: {show: true, lineStyle: {color: warmpalette[7],}}, min: 0, max: {{ impianto.potenza_installata|stringformat:".2f" }},
                        axisLabel: {
                              formatter: val => val === 0 ? '': val
                        },axisTick: {show: true}
                    },
                    {
	                      gridIndex: 0, type: 'value', name: 'Portata ({{ impianto.unita_misura }})', nameLocation: 'middle', nameGap: 30,
	                      axisLine: {show: true, lineStyle: {color: coolpalette[7],}}, min: 0, max: {{ impianto.Var2_max|stringformat:".2f" }},
	                      axisLabel: {
                              formatter: val => val === 0 ? '': val
                        },axisTick: {show: true}
                    },
                    {
	                      gridIndex: 1, type: 'value', position:'left',name: 'Rendimento (%)', 
	                      nameLocation: 'middle', nameGap: 30, max: 100, min: 0, axisLine: {show: true, lineStyle: {color: warmpalette[2],}},
	                      axisLabel: {
                              formatter: val => val === 0 ? '': val
                        },axisTick: {show: true}
                    },
                    {
                        gridIndex: 1, type: 'value', position:'right',offset: 50,name: 'Portata ({{ impianto.unita_misura }})', 
	                      nameLocation: 'middle', nameGap: 30, axisLine: {show: true, lineStyle: {color: coolpalette[7]} },
	                      axisLabel: {
                              formatter: val => val === 0 ? '': val
                        },axisTick: {show: true}, min: 0, max: {{ impianto.Var2_max|stringformat:".2f" }}*1.5,
                    },
                    {
                        gridIndex: 1, type: 'value', position:'right',name: 'Pressione (BarG)', 
	                      nameLocation: 'middle', nameGap: 30, axisLine: {show: true, lineStyle: {color: coolpalette[4]}},
	                      axisLabel: {
                              formatter: val => val === 0 ? '': val
                        },axisTick: {show: true},  min: 0, max: {{ impianto.Var3_max|stringformat:".2f" }}*2,
                    },
                ],
								/* DATI - LINEE */
                series: [
                    /* POTENZA */
						{
								name: 'Potenza', type: 'line', data: dataPotenza,
                        areaStyle: {
	                          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
			                          {offset: 0, color: warmpalette[7]}, 
			                          {offset: 1, color: warmpalette[6]}
	                          ])
                        },
                        markLine: {data: [{ type:'average',label:{position:'insideEndTop', backgroundColor: '#efefef',
			                          formatter: params => safeToLocale(params.value,2) + ' kW'}}],},
                        xAxisIndex: 0, yAxisIndex: 0, lineStyle: {width: 1,},showSymbol: false, large: true,
                        tooltip: {valueFormatter: value => safeToLocale(value,2) + ' kW'}
                    },
		                /* PORTATA */
						{
								name: 'Portata', type: 'line', xAxisIndex: 0, yAxisIndex: 1, data: dataPortata,
                        lineStyle: {width: 0.8,},emphasis: {focus: 'series'},showSymbol: false, large: true,
                        markLine: {data: [{ type:'average',label:{position:'insideEndTop', backgroundColor: '#efefef',
			                          formatter: params => safeToLocale(params.value,2) + ' {{ impianto.unita_misura }}'}}],},
                        tooltip: {valueFormatter: value => safeToLocale(value,2) + ' {{ impianto.unita_misura }}'}
                    },
		                /* ---------------------------------------------------------------------------------------------- */
		                /* RENDIMENTO */
						{
								data: dataRendimento, type: 'line', name: 'Rendimento', xAxisIndex: 1, yAxisIndex: 2, smooth: true,
                        lineStyle: {width: 1.5,},showSymbol: false, large: true,
                        markLine: {data: [{ type:'average', 
			                          label:{position:'insideEndTop', backgroundColor: '#efefef',
			                          formatter: params => safeToLocale(params.value,2) + ' %'}}],},
                        tooltip: {valueFormatter: value => safeToLocale(value,2) + ' %'}
                    },
		                /* PORTATA */
						{
								name: 'Portata ', type: 'line', xAxisIndex: 1, yAxisIndex: 3, data: dataPortata,
                        showSymbol: false, lineStyle: {width: 0.8,}, large: true,
	                      tooltip: {valueFormatter: value => safeToLocale(value,2) + ' {{ impianto.unita_misura }}'}
                    },
		                /* PRESSIONE */
						{
								name: 'Pressione', type: 'line', xAxisIndex: 1, yAxisIndex: 4, data: dataPressione,
	                      showSymbol: false, lineStyle: {width: 1,}, large: true,
	                      markLine: {data: [{ type:'average',label:{position:'insideEndTop', backgroundColor: '#efefef',
					                      formatter: params => safeToLocale(params.value,2) + ' BarG'}}],},
	                      tooltip: {valueFormatter: value => safeToLocale(value,2) + ' BarG'}
                    }
                ]
						});
						console.log('Grafico principale configurato');
                
						/* GRAFICO DATI 3D */
						console.log('Configurazione grafico 3D...');
						Chart2.setOption({
								grid3D: {viewControl: {projection: 'orthographic'}},
								color: ['rgb(61,114,196)','rgb(166,220,83)','rgb(255,41,0)'],
								tooltip: {},
								xAxis3D: {name: 'Portata', axisLabel: {formatter: '{value} {{ impianto.unita_misura }}'}, axisLine: {show: true, lineStyle: {color: coolpalette[7]}}}, 
								yAxis3D: {name: 'Pressione', axisLabel: {formatter: '{value} BarG'}, axisLine: {show: true, lineStyle: {color: coolpalette[4]}}}, 
								zAxis3D: {min: 0, max: 100, name: 'Rendimento',axisLabel: {formatter: '{value} %'}, position: 'right'},
								legend: {},
								series: [
										{data: coords, type: 'scatter3D', symbolSize: 1.5, name: 'Dati da inizio anno'},
										{data: coords.slice(-672), type: 'scatter3D', symbolSize: 3, name: 'Dati ultima settimana'},
										{data: coords.slice(-1), type: 'scatter3D', symbolSize: 6, name: 'Ultimo dato'},
								]
						})
						console.log('Grafico 3D configurato');
						console.log('Configurazione grafici completata');
				}).fail(function(xhr, status, error) {
						console.error('Errore nella chiamata AJAX:', error);
						console.error('Status:', status);
						console.error('Response:', xhr.responseText);
				});
		})
</script>